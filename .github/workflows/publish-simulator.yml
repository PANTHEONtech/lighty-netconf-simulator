name: Publish netconf-simulator

on:
  workflow_dispatch:
    inputs:
      version:
        description: Desired version of published docker image & helm charts, e.g. "XX.YY.ZZ"
        required: true
      image-tag-latest:
        description: Should this docker image be labeled with tag latest? Enter `true` if yes.
        default: "true"
        required: true
      checkout-ref:
        description: The branch, tag, or SHA to checkout. Use "default" to use the current branch.
        default: default
        required: true

jobs:
  publish-docker-helm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    name: "Publish netconf-simulator docker image"
    env:
      IMAGE_NAME: "netconf-simulator"
      REGISTRY: "ghcr.io/pantheontech"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.checkout-ref != 'default' && github.event.inputs.checkout-ref || github.ref_name }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'

      - name: Build lighty-netconf-simulator
        run: |
          echo "Building lighty-netconf-simulator..."
          mvn -B install -DskipTests

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          VERSION=${{ inputs.version }}
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

          docker build -t ${IMAGE}:${VERSION} .

          if [ "${{ inputs.image-tag-latest }}" = "true" ]; then
            docker tag ${IMAGE}:${VERSION} ${IMAGE}:latest
          fi

          echo "Built images:"
          docker images ${IMAGE}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          VERSION=${{ inputs.version }}

          echo "Pushing ${IMAGE}:${VERSION}"
          docker push ${IMAGE}:${VERSION}

          if [ "${{ inputs.image-tag-latest }}" = "true" ]; then
            echo "Pushing ${IMAGE}:latest"
            docker push ${IMAGE}:latest
          fi

      - name: Verify image pull works
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          VERSION=${{ inputs.version }}

          echo "Testing pull of ${IMAGE}:${VERSION}"
          docker rmi ${IMAGE}:${VERSION} || true
          docker pull ${IMAGE}:${VERSION}
